# 网络和网络编程

# 1 网络协议和网络模型
在使用网络通信时，可以认为是由一端程序发起了请求而由另一端回复了一个响应。发起请求的那一端称作客户端，响应的那一端称作服务端。

网络协议规定了通信两端数据交互的规则。层次之间存在着上下层关系，上层依赖于下层，它需要调用下层提供的接口才能工作。

OSI网络模型有七层模型：分别是应用层、表示层、会话层、传输层、网络层、数据链路层和物理层，但是目前广泛使用的是TCP/IP协议族网络模型，它是四层模型：从上往下依次是应用层、传输层、网络层和网络接口层。

![](img/2023-10-11-20-29-32.png)

网络协议是针对同一层之间的通信生效的
在网络编程的学习过程中，最重要的参考资源是RFC文档。

# 2 TCP/IP协议族
## 2.1 四层模型的各层实体
在四层模型当中，完成每一层功能的实体如下：
* 物理层：通常指实际传输的物理设备，比如线缆、调制解调器等设备，数据在这些设备中以比特流的形式就行传播。
* 数据链路层：通常是指网卡的驱动程序。该层将比特流转换成数据帧，MAC地址是用来描述不同的数据链路层设备的地址。
* 网络层：通常指不同的主机。网络层负责将数据帧封装成IP数据报。使用IP地址来描述主机在网络层的位置。网络层之间采用逐机跳转的通信方式。
* 传输层：负责将IP数据报封装成TCP段或UDP报文。该层可以为两台主机的应用程序提供端到端的通信。传输层只关心通信的起始端和目的端，不关心数据的中转过程。
* 应用层：负责处理应用程序的逻辑。

每个层次能够处理的数据单位称作 协议数据单元（PDU），不同层次之间的协议数据单元也是不同的，数据在上层下层之间传递时，需要使用一定的手段转换协议数据单元。

![](img/2023-10-11-20-30-04.png)

## 2.2 协议数据单元的转移
当数据从上层转移到下层时，下层的数据单元会把上层数据单元的所有内容包含进来。作为下层协议数据单元的有效载荷，除此还需要在头部或者是尾部增加下层的控制信息。其中TCP段/UDP报文会在数据中增加端口等信息作为头部。IP数据报会在TCP段/UDP报文的内容头部的添加IP地址等控制信息。

![](img/2023-10-11-20-31-01.png)

![](img/2023-10-11-20-04-00.png)

数据链路层帧的处理会相对复杂一点。在数据链路层存在一个MTU参数。它的数值决定了数据帧有效载荷的最大长度（单位是字节），长度超过MTU的数据帧将无法传递到网络层。常用的MTU值有1500、576等，而IP数据报总长度上限为65535个字节。

## 2.3 常见协议以及分层
![](img/2023-10-11-20-18-51.png)

![](img/2023-10-11-20-19-03.png)

## 2.4 ifconfig
ipconfig命令（Windows版本是ipconfig）可以展示本地网卡的信息，其中ens33（有些系统是使用eth0）是表示以太网网卡，而lo表示loopback本地回环设备。

![](img/2023-10-11-20-21-42.png)

## 2.5 本地环回设备
在有些情况，通信的服务端和客户端会位于同一台主机之上，操作系统提供了一种环回网络接口来实现同一主机上两端通信，环回设备是一种虚拟的网络设备

# 3 以太网
# 3.1 以太网和交换机
以太网是最常用的数据链路层标准之一。
网桥和交换机（就是高性能版网桥）是工作在数据链路层(L2)上的设备，它们可以用来将多个链路层网络连接起来，从而构成一个拓展的局域网。

# 3.2 以太网帧
以太网中处理的协议数据单元是以太网帧，目的地址（6字节）、源地址（6字节）、类型（2字节）、变长的数据（46~1500字节，所以以太网的MTU是1500）和CRC（4个字节）。
1. 在目的地址和源地址字段当中填写的是设备的硬件地址
（MAC地址），而不是主机的IP地址。
2. 类型字段中说明以太网帧载荷的类型
3. 。数据字段的长度范围是46字节到1500字节，如果IP数据报的内容不足46个字节，则会在末尾填充（padding）上0。
4. CRC部分是一种校验码，用于校验数据传递过程是否出现比特跳变

![](img/2023-10-11-20-16-38.png)

# 3.3 ARP协议
在网络传输中，我们使用IP地址来定位主机的位置，通常来说IP地址的选择是任意的，但是网络设备在链路层上的MAC地址是由生产厂商分配是固定的。

需要使用一种协议来执行地址解析，即IP地址和MAC地址之间的映射转换--这就是ARP协议的作用

> 当一台主机接入网络之后，假如它需要向自己所在局域网的设备发送数据，那么它就需要知道邻居IP地址和MAC地址之间的映射关系。
> 主机会发送一个ARP请求，ARP请求会向在一个共享的链路层网段上所有主机发送（广播，此时以太网帧的目的MAC每一位都填1），并且获取这个问题的答案“谁拥有IP192.168.3.1，请告知自己的MAC地址？”。IP地址不是192.168.3.1的设备会忽略此请求，但是拥有IP地址192.168.3.1的设备会直接回复一个ARP应答给源主机，在接收到应答之后，源主机再向192.168.3.1发送数据就不再需要广播而是直接交付了。

![](img/2023-10-12-10-22-28.png)

![](img/2023-10-12-10-23-24.png)

使用抓包和分析工具的过程
1. 指定要抓取的网卡
2. 开始捕获 -> 停止
3. 输入表达式进行筛选

# 4 IP协议


# 5 TCP协议


# 6 UDP协议